{% extends 'website/base.html' %}
{% load static %}

{% block title %}Foundation Building: Personality Assessment{% endblock %}

{% block content %}

<div class="max-w-7xl mx-auto mt-6 bg-white shadow-xl rounded-lg overflow-hidden">

    <!-- Header -->
    <div class="max-w-7xl mx-auto bg-white shadow-lg rounded-lg overflow-hidden">
    <!-- Header -->
    <div class="flex justify-between items-center p-5 border-b border-gray-200 bg-white">
        <div class="flex items-center mx-5">
            <img src="{% static 'images/assessment_icon.png' %}" alt="Logo" class="h-10 mr-3">
            <div>
                <h1 class="text-xl font-bold text-gray-800">Foundation Building: Personality Assessment</h1>
                <p class="text-sm text-gray-500">Discover Your Inner Pro</p>
            </div>
        </div>
        <div class="flex items-center gap-5">
            <div class="flex items-center text-base font-medium text-gray-700">
                <img src="{% static 'images/timer_icon.png' %}" alt="Timer" class="h-5 mr-2">
                <span id="timer">10:00</span>
            </div>
            <button type="submit" form="quiz-form" class="bg-cyan-500 hover:bg-cyan-600 text-white px-5 py-2 rounded font-semibold shadow">
                Finish
            </button>
        </div>
    </div>

    <!-- Reward Banner -->
    <div class="bg-white px-6 py-3 border-b border-gray-200 flex items-center gap-3">
        <img src="{% static 'images/gift_icon.png' %}" alt="Reward" class="h-6 animate-bounce">
        <p class="text-sm text-purple-700">Answer all questions to unlock your next avatar upgrade!</p>
    </div>
    
    
    <!-- Main Body -->
    <div class="flex flex-col md:flex-row min-h-[600px]">

        <!-- Question Panel -->
        <div class="flex-1 p-6 border-r border-gray-200 bg-white">
            <form id="quiz-form" method="POST" action="{% url 'submit_level1' %}">
                {% csrf_token %}
                <div id="question-area" class="space-y-5"></div>

                <!-- Navigation -->
                <div class="flex justify-between mt-6">
                    <button type="button" id="prev-btn" class="bg-cyan-500 hover:bg-cyan-600 text-white px-5 py-2 rounded shadow">
                        Previous
                    </button>
                    <button type="button" id="next-btn" class="bg-cyan-500 hover:bg-cyan-600 text-white px-5 py-2 rounded shadow">
                        Next
                    </button>
                </div>

                <!-- Mark Button -->
                <button type="button" id="mark-btn" class="mt-5 w-full bg-yellow-400 hover:bg-yellow-500 text-black font-semibold py-2 px-4 rounded shadow">
                    Mark for Review
                </button>
            </form>

            <!-- Avatar Selection Grid -->
            <div class="mt-6 border border-gray-200 rounded-lg p-4 bg-gray-50">
                <div class="grid grid-cols-4 gap-4">
                    {% for n in "12345678" %}
                        {% with forloop.counter|stringformat:"d" as num %}
                            {% with 'images/avatar'|add:n|add:'.png' as avatar_path %}
                                <div class="text-center transition-transform transform hover:scale-105 cursor-pointer">
                                    <img src="{% static avatar_path %}" alt="Avatar" class="selectable-avatar w-16 mx-auto rounded-lg mb-2 shadow-sm">
                                    <p class="text-xs text-gray-700">{{ name }}</p> <!-- Consider dynamic value -->
                                </div>
                            {% endwith %}
                        {% endwith %}
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <aside class="w-full md:w-72 bg-gray-50 p-5 border-l border-gray-200 overflow-y-auto">

            <!-- Current Avatar -->
            <div class="flex items-center mb-6">
                <img id="current-avatar-img" src="{% static 'images/user_avatar.png' %}" alt="Avatar" class="h-10 mr-3">
                <p class="font-semibold text-gray-700">Current Avatar</p>
            </div>

            <!-- Status Legend -->
            <div class="space-y-2 mb-6 text-xs">
                <div class="flex items-center"><span class="w-3 h-3 bg-green-500 rounded-full mr-2"></span>Answered</div>
                <div class="flex items-center"><span class="w-3 h-3 bg-yellow-400 rounded-full mr-2"></span>Marked</div>
                <div class="flex items-center"><span class="w-3 h-3 bg-gray-300 rounded-full mr-2"></span>In Progress</div>
            </div>

            <!-- Progress Bar -->
            <div class="m-3 flex items-center">
        
                <div class="w-1/3 bg-gray-200 rounded-full h-2 ">
                    <div id="progress-bar-fill" class="bg-cyan-500 h-2 rounded-full transition-all duration-300" style="width: 0%;"></div>
                </div>
                <div class="text-right text-sm text-gray-700 mt-1">
                            <span id="progress-count">0</span>/<span id="total-count">{{ questions|length }}</span>
                </div>

            </div>

            <!-- Question Navigator -->
            <h3 class="font-semibold text-lg text-gray-800 mb-3">Questions</h3>
            <div class="grid grid-cols-5 gap-2" id="nav-buttons">
                {% for question in questions %}
                    <button class="nav-btn bg-gray-300 text-sm font-medium rounded px-2 py-1"
                            data-index="{{ forloop.counter0 }}"
                            id="nav-btn-{{ forloop.counter0 }}">
                        {{ question.question_number }}
                    </button>
                {% endfor %}
            </div>
        </aside>
    </div>
</div>

<!-- JSON Payload -->
<script id="questions-data" type="application/json">
  {{ formatted_questions|safe }}
</script>

<!-- Dynamic JS logic continues below... -->




<!-- Dynamic Logic -->
<script>
const parsedQuestions = JSON.parse(document.getElementById('questions-data').textContent);
let currentIndex = 0;
let answers = {};
let marked = new Set();

function renderQuestion(index) {
    const q = parsedQuestions[index];
    const container = document.getElementById("question-area");
    container.innerHTML = `
        <div class="border border-gray-200 rounded-lg p-5">
            <p class="text-sm text-gray-600 mb-2">Question ${q.question_number} of ${parsedQuestions.length}</p>
            <p class="text-lg font-semibold mb-4">${q.question_text}</p>
            <ul class="space-y-3">
                ${q.options.map(opt => `
                    <li>
                        <label class="flex items-center px-4 py-2 bg-gray-100 rounded hover:bg-gray-200 cursor-pointer">
                            <input type="radio" name="question_${q.id}" value="${opt.id}" class="mr-3"
                            ${answers[q.id] == opt.id ? 'checked' : ''}>
                            ${opt.text}
                        </label>
                    </li>
                `).join('')}
            </ul>
        </div>
    `;
    updateNavColors();
    updateProgressBar(); // ✅ 
}

function updateNavColors() {
    parsedQuestions.forEach((q, i) => {
        const btn = document.getElementById(`nav-btn-${i}`);
        if (marked.has(i)) {
            btn.className = "nav-btn bg-yellow-400 px-2 py-1 rounded";
        } else if (answers[q.id]) {
            btn.className = "nav-btn bg-green-400 px-2 py-1 rounded";
        } else {
            btn.className = "nav-btn bg-gray-300 px-2 py-1 rounded";
        }
    });
}

function saveAnswer() {
    const q = parsedQuestions[currentIndex];
    const selected = document.querySelector(`input[name="question_${q.id}"]:checked`);
    if (selected) {
        answers[q.id] = selected.value;
        let existingInput = document.querySelector(`#input-q-${q.id}`);
        if (!existingInput) {
            existingInput = document.createElement("input");
            existingInput.type = "hidden";
            existingInput.name = `question_${q.id}`;
            existingInput.id = `input-q-${q.id}`;
            document.getElementById("quiz-form").appendChild(existingInput);
        }
        existingInput.value = selected.value;
    }
    checkCompletionAndUpdateAvatar();
    updateProgressBar(); // ✅ 
}
function updateProgressBar() {
    const attempted = parsedQuestions.filter(q => answers[q.id]).length;
    const total = parsedQuestions.length;
    const percent = (attempted / total) * 100;
    
    document.getElementById("progress-bar-fill").style.width = `${percent}%`;
    document.getElementById("progress-count").textContent = attempted;
}

// Button listeners
document.getElementById("prev-btn").addEventListener("click", () => {
    saveAnswer();
    if (currentIndex > 0) currentIndex--;
    renderQuestion(currentIndex);
});

document.getElementById("next-btn").addEventListener("click", () => {
    saveAnswer();
    if (currentIndex < parsedQuestions.length - 1) currentIndex++;
    renderQuestion(currentIndex);
});

document.getElementById("mark-btn").addEventListener("click", () => {
    marked.add(currentIndex);
    updateNavColors();
});

document.querySelectorAll(".nav-btn").forEach(btn => {
    btn.addEventListener("click", () => {
        saveAnswer();
        currentIndex = parseInt(btn.dataset.index);
        renderQuestion(currentIndex);
    });
});

// Timer
let totalSeconds = 10 * 60;
const timerEl = document.getElementById("timer");
const timerInterval = setInterval(() => {
    totalSeconds--;
    const mins = String(Math.floor(totalSeconds / 60)).padStart(2, '0');
    const secs = String(totalSeconds % 60).padStart(2, '0');
    timerEl.textContent = `${mins}:${secs}`;
    if (totalSeconds <= 0) {
        clearInterval(timerInterval);
        document.getElementById("quiz-form").submit();
    }
}, 1000);
// Dynamic Avatar Change
document.querySelectorAll('.selectable-avatar').forEach(img => {
    img.addEventListener('click', () => {
        const allAnswered = parsedQuestions.every(q => answers[q.id]);
        if (!allAnswered) {
            alert("Please complete all questions to unlock avatar changes.");
            return;
        }
        const selectedSrc = img.getAttribute('data-src');
        document.getElementById('current-avatar-img').setAttribute('src', selectedSrc);
    });
});

function checkCompletionAndUpdateAvatar() {
    const allAnswered = parsedQuestions.every(q => answers[q.id]);
    if (allAnswered) {
        // You could randomly pick a new avatar, or unlock a special one
        const unlockedAvatar = "{% static 'images/avatar8.png' %}";
        document.getElementById('current-avatar-img').setAttribute('src', unlockedAvatar);
    }
}

// Initial load
renderQuestion(currentIndex);
</script>
{% endblock %}
